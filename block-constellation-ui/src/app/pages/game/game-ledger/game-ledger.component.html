<!-- Loading State -->
<div class="loading-state" *ngIf="loadingLedger">
  <div class="container">
    <div class="ledger-skeleton skeleton"></div>
  </div>
</div>

<!-- Main Content -->
<div class="star-ledger" *ngIf="!loadingLedger">
  <div class="container">

    <!-- Status Message -->
    <div class="status-message" *ngIf="statusMessage" [ngClass]="statusType">
      {{ statusMessage }}
    </div>

    <!-- Wallet Connection Prompt -->
    <div class="wallet-connection-prompt" *ngIf="!walletConnected">
      <div class="cosmic-card">
        <h2>Connect to the Cosmos</h2>
        <p>Please connect your wallet to view the Star Ledger and claim your Cosmic Bounties</p>
        <button class="cosmic-button">Connect Wallet</button>
      </div>
    </div>

    <!-- Star Ledger Content -->
    <div class="ledger-content" *ngIf="walletConnected && selectedEpoch">
      <!-- Navigation -->
      <div class="epoch-navigator">
        <button 
          class="nav-button prev" 
          [disabled]="selectedEpochId <= 0" 
          (click)="loadPreviousEpoch()"
          [class.disabled]="selectedEpochId <= 0">
          <span class="arrow">‚Üê</span> Previous Epoch
        </button>
        
        <div class="epoch-selector">
          <h2>Epoch #{{ selectedEpoch.id }}</h2>
          <div class="epoch-status" *ngIf="selectedEpoch.isCurrent">
            <span class="status-indicator current"></span> Current Epoch
          </div>
        </div>
        
        <button 
          class="nav-button next" 
          [disabled]="selectedEpochId >= currentEpochId - 1" 
          (click)="loadNextEpoch()"
          [class.disabled]="selectedEpochId >= currentEpochId - 1">
          Next Epoch <span class="arrow">‚Üí</span>
        </button>
      </div>

      <!-- Epoch Details -->
      <div class="cosmic-card epoch-details">
        <div class="epoch-details-container">
          <div class="cosmic-pool">
            <div class="pool-icon">üåå</div>
            <div class="pool-details">
              <h3>Cosmic Pool</h3>
              <p class="pool-value">{{ formatBTC(selectedEpoch.totalStakedPool) }} BTC</p>
            </div>
          </div>

          <!-- Winning Constellation Reveal -->
          <div class="winning-constellation">
            <h3>Winning Constellation</h3>
            <div class="constellation-reveal">
              <div class="constellation-name">{{ selectedEpoch.winningConstellationName }}</div>
              <div class="constellation-id">#{{ selectedEpoch.winningConstellation }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- No Allocations Message -->
      <div class="cosmic-card no-allocations" *ngIf="selectedEpoch.userAllocations.length === 0">
        <h3>No Cosmic Alignments Found</h3>
        <p>You didn't stake in this epoch. Align with the cosmos in future epochs to receive rewards!</p>
      </div>

      <!-- Reward Claim Section -->
      <div class="cosmic-card reward-claim" *ngIf="selectedEpoch.userWinningAllocation > 0">
        <div class="reward-status">
          <!-- Status heading and message -->
          <div *ngIf="!selectedEpoch.claimed">
            <h3>Cosmic Bounty Available!</h3>
            <p>The stars have aligned in your favor! Your stake of {{ formatSats(selectedEpoch.userWinningAllocation) }} sats was aligned with the winning constellation.</p>
          </div>
          <div *ngIf="selectedEpoch.claimed">
            <h3>Cosmic Bounty Claimed</h3>
            <p>You've already claimed your reward for this epoch. The cosmos will present new opportunities in future epochs!</p>
          </div>
          
          <!-- Always show Reward Details when there's a winning allocation -->
          <div class="reward-details">
            <div class="reward-info">
              <i class="info-icon">‚ÑπÔ∏è</i>
              <span class="info-text">Cosmic Bounty is calculated based on your percentage of the total stake in the winning constellation.</span>
            </div>
            <div class="reward-item">
              <span class="label">Your Cosmic Bounty:</span>
              <span class="value">{{ formatSats(selectedEpoch.userRewardAmount) }} sats</span>
            </div>
            <div class="reward-item">
              <span class="label">Total Staked in {{ selectedEpoch.winningConstellationName }}:</span>
              <span class="value">{{ formatSats(selectedEpoch.winningConstellationTotalStake) }} sats</span>
            </div>
            <div class="reward-item">
              <span class="label">Your Allocation Percentage:</span>
              <span class="value">{{ formatPercentage(selectedEpoch.userAllocationPercentage) }}</span>
            </div>
          </div>
        </div>

        <!-- Only show claim button for unclaimed rewards -->
        <button 
          class="cosmic-button claim-button" 
          *ngIf="selectedEpoch && selectedEpoch.userWinningAllocation > 0 && !selectedEpoch.claimed && !selectedEpoch.isCurrent && walletConnected"
          [disabled]="claimingReward"
          (click)="claimReward()">
          {{ claimingReward ? 'Claiming...' : 'Claim Cosmic Bounty' }}
        </button>
        
        <!-- Show claimed message if already claimed -->
        <div class="claimed-message" *ngIf="selectedEpoch.userWinningAllocation > 0 && selectedEpoch.claimed">
          <p>‚úÖ Cosmic Bounty has been successfully claimed</p>
        </div>
      </div>

      <!-- User Allocations -->
      <div class="cosmic-card user-allocations" *ngIf="selectedEpoch.userAllocations.length > 0">
        <h3>Your Cosmic Alignments</h3>
        <table class="allocations-table">
          <thead>
            <tr>
              <th>Constellation</th>
              <th>Your Stake</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let allocation of selectedEpoch.userAllocations" [class.winning]="allocation.isWinner">
              <td>{{ allocation.constellationName }}</td>
              <td>{{ formatSats(allocation.amount) }} sats</td>
              <td>
                <div class="status-indicator-wrapper">
                  <span class="status-indicator" [class.winning]="allocation.isWinner"></span>
                  {{ allocation.isWinner ? 'Aligned!' : 'Not Aligned' }}
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>
