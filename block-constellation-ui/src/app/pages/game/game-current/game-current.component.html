<!-- Loading State -->
<div class="loading-state" *ngIf="loadingPage">
  <div class="container">
    <div class="epoch-strip skeleton"></div>
    <div class="constellation-grid skeleton">
      <div class="constellation-card skeleton" *ngFor="let i of [].constructor(24)"></div>
    </div>
  </div>
</div>

<!-- Actual Content (when loaded) -->
<ng-container *ngIf="!loadingPage">

  <!-- Epoch Strip -->
  <div class="epoch-strip">
    <div class="container">
      <div class="epoch-info">
        <div class="epoch-id">
          <h2>Epoch #{{ currentEpoch }}</h2>
        </div>

        <div class="epoch-progress">
          <div class="blocks-remaining">
            {{ blocksRemaining }} of {{ totalBlocks }} blocks remaining
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="((totalBlocks - blocksRemaining) / totalBlocks) * 100"></div>
          </div>
          <div class="eta">
            Estimated time remaining: {{ estimatedTimeRemaining }}
          </div>
        </div>

        <div class="cosmic-pool">
          <div class="cosmic-bounty-container">
            <div class="cosmic-stars left"><i>✧</i><i>★</i><i>✦</i></div>
            <p><span class="bounty-label">Cosmic Bounty: </span> <span class="bounty-amount">{{ formatBTC(totalStakedPool) }} BTC</span> <br> <span class="usd-value" *ngIf="btcPrice > 0">(≈ {{ formatUSD(totalStakedPool * btcPrice) }})</span></p>
            <div class="cosmic-stars right"><i>✦</i><i>★</i><i>✧</i></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top-up Alert (if balance is low) -->
  <div class="top-up-alert" *ngIf="walletConnected && feeBalance < 1000">
    <div class="container">
      <p>You need ≥ 1,000 sats to stake. <button class="btn-deposit">Deposit</button></p>
    </div>
  </div>

  <!-- User Allocation Summary (if user has stakes) -->
  <div class="allocation-summary" *ngIf="walletConnected && userAllocation.totalStaked > 0">
    <div class="container">
      <div class="summary-content" (click)="toggleAllocationSummary()">
        <p>You staked {{ formatSats(userAllocation.totalStaked) }} sats across {{ userAllocation.constellationCount }}
          constellations.</p>
        <span class="toggle-icon" [class.active]="showAllocationSummary">▼</span>
      </div>

      <!-- Allocation Details Popover -->
      <div class="allocation-details" *ngIf="showAllocationSummary">
        <table>
          <thead>
            <tr>
              <th>Constellation</th>
              <th>Staked Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let allocation of userAllocation.allocations">
              <td>{{ allocation.constellation }}</td>
              <td>{{ formatSats(allocation.amount) }} sats</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>



  <!-- Constellation Grid -->
  <div class="constellation-section">
    <div class="container">

      <!-- Connect Wallet Component -->
      <app-connect-wallet *ngIf="!walletConnected" title="Connect to the Cosmos"
        description="Connect your wallet to stake on constellations" buttonText="Connect Wallet"
        (connectWallet)="connectWallet()">
      </app-connect-wallet>

      <div class="constellation-grid">
        <!-- Constellation Cards -->
        <app-game-constellation-card
          *ngFor="let constellation of constellations"
          [constellation]="constellation"
          [walletConnected]="walletConnected"
          [hasPendingTransaction]="hasPendingTransaction(constellation.id)"
          (selectCard)="selectConstellation($event)">
        </app-game-constellation-card>
      </div>
    </div>
  </div>
</ng-container>

<!-- Stake Action Component -->
<app-game-stake-action
  [isOpen]="isDrawerOpen"
  [constellation]="selectedConstellation"
  [feeBalance]="feeBalance"
  [btcPrice]="btcPrice"
  (close)="closeStakeDrawer()"
  (stakeConfirmed)="handleStakeConfirmed($event)">
</app-game-stake-action>