<!-- Loading State -->
<div class="loading-state" *ngIf="loadingPage">
  <div class="container">
    <div class="epoch-strip skeleton"></div>
    <div class="constellation-grid skeleton">
      <div class="constellation-card skeleton" *ngFor="let i of [].constructor(24)"></div>
    </div>
  </div>
</div>

<!-- Actual Content (when loaded) -->
<ng-container *ngIf="!loadingPage">

  <!-- Epoch Strip -->
  <div class="epoch-strip">
    <div class="container">
      <div class="epoch-info">
        <div class="epoch-id">
          <h2>Epoch #{{ currentEpoch }}</h2>
        </div>

        <div class="epoch-progress">
          <div class="blocks-remaining">
            {{ blocksRemaining }} of {{ totalBlocks }} blocks remaining
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="((totalBlocks - blocksRemaining) / totalBlocks) * 100"></div>
          </div>
          <div class="eta">
            Estimated time remaining: {{ estimatedTimeRemaining }}
          </div>
        </div>

        <div class="cosmic-pool">
          <div class="cosmic-bounty-container">
            <div class="cosmic-stars left"><i>✧</i><i>★</i><i>✦</i></div>
            <p><span class="bounty-label">Cosmic Bounty: </span> <span class="bounty-amount">{{ formatBTC(totalStakedPool) }} BTC</span> <span class="usd-value" *ngIf="btcPrice > 0">(≈ {{ formatUSD(totalStakedPool * btcPrice) }})</span></p>
            <div class="cosmic-stars right"><i>✦</i><i>★</i><i>✧</i></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top-up Alert (if balance is low) -->
  <div class="top-up-alert" *ngIf="walletConnected && feeBalance < 1000">
    <div class="container">
      <p>You need ≥ 1,000 sats to stake. <button class="btn-deposit">Deposit</button></p>
    </div>
  </div>

  <!-- User Allocation Summary (if user has stakes) -->
  <div class="allocation-summary" *ngIf="walletConnected && userAllocation.totalStaked > 0">
    <div class="container">
      <div class="summary-content" (click)="toggleAllocationSummary()">
        <p>You staked {{ formatSats(userAllocation.totalStaked) }} sats across {{ userAllocation.constellationCount }}
          constellations.</p>
        <span class="toggle-icon" [class.active]="showAllocationSummary">▼</span>
      </div>

      <!-- Allocation Details Popover -->
      <div class="allocation-details" *ngIf="showAllocationSummary">
        <table>
          <thead>
            <tr>
              <th>Constellation</th>
              <th>Staked Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let allocation of userAllocation.allocations">
              <td>{{ allocation.constellation }}</td>
              <td>{{ formatSats(allocation.amount) }} sats</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>



  <!-- Constellation Grid -->
  <div class="constellation-section">
    <div class="container">

      <!-- Connect Wallet Component -->
      <app-connect-wallet *ngIf="!walletConnected" title="Connect to the Cosmos"
        description="Connect your wallet to stake on constellations" buttonText="Connect Wallet"
        (connectWallet)="connectWallet()">
      </app-connect-wallet>

      <div class="constellation-grid">
        <!-- Constellation Cards -->
        <div class="constellation-card" *ngFor="let constellation of constellations"
          [class.has-stake]="walletConnected && constellation.yourStake > 0"
          [class.has-pending]="walletConnected && hasPendingTransaction(constellation.id)"
          (click)="walletConnected && selectConstellation(constellation)">
          <div class="card-content">
            <h3 class="constellation-name">{{ constellation.name }}</h3>
            <p class="constellation-meaning">{{ constellation.meaning }}</p>

            <div class="stake-info">
              <div class="total-staked">
                {{ formatBTC(constellation.totalStaked) }} BTC staked
              </div>

              <!-- User-specific data only shown when wallet is connected -->
              <ng-container *ngIf="walletConnected">
                <div class="your-stake" *ngIf="constellation.yourStake > 0">
                  Your stake: {{ formatSats(constellation.yourStake) }} sats
                </div>

                <div class="your-share" *ngIf="constellation.yourStake > 0">
                  Your share: {{ Math.min(constellation.yourShare, 100).toFixed(2) }}%
                </div>

                <div class="pending-indicator" *ngIf="hasPendingTransaction(constellation.id)">
                  <span class="status-indicator pending"></span> Transaction Pending
                </div>

                <button class="btn-stake">
                  {{ constellation.yourStake > 0 ? 'Add Stake' : 'Stake' }}
                </button>
              </ng-container>

              <!-- For unconnected wallets, show a prompt instead of stake button -->
              <div class="connect-prompt" *ngIf="!walletConnected">
                <p>Connect wallet to stake</p>
              </div>
            </div>
          </div>

          <div class="stake-tag" *ngIf="walletConnected && constellation.yourStake > 0">
            <i class="cosmic-star">★</i> Staked
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Stake Drawer -->
<div class="stake-drawer" [class.open]="isDrawerOpen" *ngIf="selectedConstellation">
  <div class="drawer-backdrop" (click)="closeStakeDrawer()"></div>
  <div class="drawer-content">
    <div class="drawer-header">
      <h3>Stake on {{ selectedConstellation.name }}</h3>
      <button class="btn-close" (click)="closeStakeDrawer()">×</button>
    </div>

    <div class="drawer-body">
      <div class="constellation-snapshot">
        <div class="snapshot-item">
          <span class="label">Total Staked:</span>
          <span class="value">{{ formatBTC(selectedConstellation.totalStaked) }} BTC <span class="usd-value" *ngIf="btcPrice > 0">(≈ {{ formatUSD(selectedConstellation.totalStaked * btcPrice) }})</span></span>
        </div>
        <div class="snapshot-item" *ngIf="selectedConstellation.yourStake > 0">
          <span class="label">You Already Staked:</span>
          <span class="value">{{ formatSats(selectedConstellation.yourStake) }} sats <span class="usd-value" *ngIf="btcPrice > 0">(≈ {{ formatUSDFromSats(selectedConstellation.yourStake) }})</span></span>
        </div>
      </div>

      <div class="stake-input-section">
        <label for="stakeAmount">Amount (sats)</label>
        <input type="number" id="stakeAmount" [(ngModel)]="stakeAmount" min="1000" step="1000" [max]="feeBalance"
          class="stake-input" [class.invalid]="stakeAmount < 1000 || stakeAmount > feeBalance">
        <div class="amount-usd-value" *ngIf="btcPrice > 0">
          <span>≈ {{ formatUSDFromSats(stakeAmount) }}</span>
        </div>

        <div class="quick-adjust">
          <button class="btn-quick" (click)="stakeAmount = 1000" [disabled]="feeBalance < 1000">MIN</button>
          <button class="btn-quick" (click)="increaseStakeAmount(2)"
            [disabled]="stakeAmount * 2 > feeBalance">2×</button>
          <button class="btn-quick" (click)="increaseStakeAmount(5)"
            [disabled]="stakeAmount * 5 > feeBalance">5×</button>
          <button class="btn-quick" (click)="increaseStakeAmount(10)"
            [disabled]="stakeAmount * 10 > feeBalance">10×</button>
          <button class="btn-quick" (click)="setMaxStake()" [disabled]="feeBalance < 1000">MAX</button>
        </div>

        <div class="balance-info" [class.insufficient]="feeBalance < 1000">
          <span class="balance-label">Your balance:</span>
          <div class="balance-value-container">
            <span class="balance-value" *ngIf="!isLoadingBalance">{{ formatSats(feeBalance) }} sats <span class="usd-value" *ngIf="btcPrice > 0">(≈ {{ formatUSDFromSats(feeBalance) }})</span></span>
            <span class="balance-value loading" *ngIf="isLoadingBalance">Loading...</span>
            <button class="btn-refresh" (click)="fetchUserBalance()" [disabled]="isLoadingBalance"
              title="Refresh Balance">
              <span class="refresh-icon">↻</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="drawer-footer">
      <div *ngIf="statusMessage" class="status-message" [ngClass]="statusType">
        {{ statusMessage }}
      </div>
      <button class="btn-cancel" (click)="closeStakeDrawer()">Cancel</button>
      <button class="btn-confirm" [disabled]="stakeAmount < 1000 || stakeAmount > feeBalance" (click)="confirmStake()">
        Confirm Stake
      </button>
    </div>
  </div>
</div>