<div class="stake-drawer" [class.open]="isOpen" *ngIf="constellation">
  <div class="drawer-backdrop" (click)="closeDrawer()"></div>
  <div class="drawer-content">
    <div class="drawer-header">
      <h3>Stake on {{ constellation.name }}</h3>
      <button class="btn-close" (click)="closeDrawer()">×</button>
    </div>

    <div class="drawer-body">
      <div class="constellation-snapshot">
        <div class="snapshot-item">
          <span class="label">Total Staked:</span>
          <span class="value">{{ formatBTC(constellation.totalStaked) }} BTC <span class="usd-value" *ngIf="btcPrice > 0">(≈ {{ formatUSD(constellation.totalStaked * btcPrice) }})</span></span>
        </div>
        <div class="snapshot-item" *ngIf="constellation.yourStake > 0">
          <span class="label">You Already Staked:</span>
          <span class="value">{{ formatSats(constellation.yourStake) }} sats <span class="usd-value" *ngIf="btcPrice > 0">(≈ {{ formatUSDFromSats(constellation.yourStake) }})</span></span>
        </div>
      </div>

      <div class="stake-input-section">
        <label for="stakeAmount">Amount (sats)</label>
        <input type="number" id="stakeAmount" [(ngModel)]="stakeAmount" min="1000" step="1000" [max]="feeBalance"
          class="stake-input" [class.invalid]="stakeAmount < 1000 || stakeAmount > feeBalance"
          [placeholder]="feeBalance >= 1000 ? '1000' : 'Insufficient balance'">
        <div class="amount-usd-value" *ngIf="btcPrice > 0">
          <span>≈ {{ formatUSDFromSats(stakeAmount) }}</span>
        </div>

        <div class="quick-adjust">
          <button class="btn-quick" (click)="stakeAmount = 1000" [disabled]="feeBalance < 1000">MIN</button>
          <button class="btn-quick" (click)="increaseStakeAmount(2)"
            [disabled]="stakeAmount * 2 > feeBalance">2×</button>
          <button class="btn-quick" (click)="increaseStakeAmount(5)"
            [disabled]="stakeAmount * 5 > feeBalance">5×</button>
          <button class="btn-quick" (click)="increaseStakeAmount(10)"
            [disabled]="stakeAmount * 10 > feeBalance">10×</button>
          <button class="btn-quick" (click)="setMaxStake()" [disabled]="feeBalance < 1000">MAX</button>
        </div>

        <div class="balance-info" [class.insufficient]="feeBalance < 1000">
          <span class="balance-label">Your balance:</span>
          <div class="balance-value-container">
            <span class="balance-value" *ngIf="!isLoadingBalance">{{ formatSats(feeBalance) }} sats <span class="usd-value" *ngIf="btcPrice > 0">(≈ {{ formatUSDFromSats(feeBalance) }})</span></span>
            <span class="balance-value loading" *ngIf="isLoadingBalance">Loading...</span>
            <button class="btn-refresh" (click)="fetchUserBalance()" [disabled]="isLoadingBalance"
              title="Refresh Balance">
              <span class="refresh-icon">↻</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="drawer-footer">
      <div *ngIf="statusMessage" class="status-message" [ngClass]="statusType">
        {{ statusMessage }}
      </div>
      <button class="btn-cancel" (click)="closeDrawer()">Cancel</button>
      <button class="btn-confirm" [disabled]="stakeAmount < 1000 || stakeAmount > feeBalance || feeBalance < 1000" (click)="confirmStake()">
        {{ feeBalance < 1000 ? 'Insufficient Balance' : 'Confirm Stake' }}
      </button>
    </div>
  </div>
</div>
